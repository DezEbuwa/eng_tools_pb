To achieve this, you'll need to set up a GitLab CI/CD pipeline that uses HashiCorp Packer to build a QCOW2 image for RHEL 9. Here's a step-by-step guide to help you set this up:

1. **Install Packer on GitLab Runner**: Ensure that your GitLab runner has Packer installed. If you're using a Docker runner, you can use a Docker image that includes Packer.

2. **Create a Packer Template**: Define a Packer template for building the QCOW2 image.

3. **GitLab CI/CD Pipeline Configuration**: Define the GitLab CI/CD pipeline to run the Packer build and save the QCOW2 image as an artifact.

### Step 1: Install Packer on GitLab Runner

If you are using a Docker executor for your GitLab runner, you can use a custom Docker image that includes Packer or install it in the pipeline script.

### Step 2: Create a Packer Template

Create a Packer template JSON or HCL file for building the RHEL 9 QCOW2 image. Here's an example using HCL:

```hcl
# rhel9-packer-template.pkr.hcl
source "qemu" "rhel9" {
  iso_url      = "path/to/rhel9.iso"
  iso_checksum = "your-checksum-here"
  output_directory = "output"
  disk_size    = "20G"
}

build {
  sources = ["source.qemu.rhel9"]

  provisioner "shell" {
    inline = ["echo Hello, World!"]
  }
}
```

### Step 3: GitLab CI/CD Pipeline Configuration

Create or update your `.gitlab-ci.yml` file to include the Packer build step and define the artifact.

```yaml
stages:
  - build

build_image:
  stage: build
  image: hashicorp/packer:latest
  script:
    - packer init rhel9-packer-template.pkr.hcl
    - packer build rhel9-packer-template.pkr.hcl
  artifacts:
    paths:
      - output/*.qcow2
```

### Detailed Explanation:

- **Stages**: Defines the stages in the pipeline. Here, we only have the `build` stage.
- **build_image**: A job in the `build` stage that uses the official HashiCorp Packer Docker image.
  - **script**: The commands to run the Packer build.
  - **artifacts**: Defines the path to the output artifacts. This will save the QCOW2 image generated by Packer.

### Putting it All Together:

Ensure you have the following files in your GitLab repository:

1. `.gitlab-ci.yml`
2. `rhel9-packer-template.pkr.hcl`
3. Any additional scripts or files referenced in your Packer template.

With this setup, when you push changes to your GitLab repository, the CI/CD pipeline will run, build the RHEL 9 QCOW2 image using Packer, and save the resulting image as an artifact.




To apply Ansible playbooks to the image created by Packer, you can use the Ansible provisioner in your Packer template. Here's how you can update the Packer template and GitLab CI/CD pipeline configuration to include Ansible playbooks.

### Step 1: Create Ansible Playbooks

Create your Ansible playbooks in your GitLab repository. For example, let's create a simple playbook that installs `httpd`:

```yaml
# playbook.yml
---
- name: Configure RHEL 9 Image
  hosts: all
  become: yes
  tasks:
    - name: Install httpd
      yum:
        name: httpd
        state: present
```

### Step 2: Update Packer Template

Modify your Packer template to include the Ansible provisioner.

```hcl
# rhel9-packer-template.pkr.hcl
source "qemu" "rhel9" {
  iso_url      = "path/to/rhel9.iso"
  iso_checksum = "your-checksum-here"
  output_directory = "output"
  disk_size    = "20G"
}

build {
  sources = ["source.qemu.rhel9"]

  provisioner "ansible" {
    playbook_file = "playbook.yml"
  }
}
```

### Step 3: GitLab CI/CD Pipeline Configuration

Update your `.gitlab-ci.yml` file to include Ansible in the pipeline.

```yaml
stages:
  - build

variables:
  PACKER_CACHE_DIR: ".packer-cache"

build_image:
  stage: build
  image: hashicorp/packer:latest
  before_script:
    # Install Ansible
    - apk update
    - apk add ansible
  script:
    - packer init rhel9-packer-template.pkr.hcl
    - packer build rhel9-packer-template.pkr.hcl
  artifacts:
    paths:
      - output/*.qcow2
```

### Detailed Explanation:

- **variables**: Define a cache directory for Packer to avoid downloading the ISO every time.
- **before_script**: Install Ansible before running the Packer build.
- **build_image**: The job that builds the image using Packer and Ansible.
  - **artifacts**: Save the QCOW2 image as an artifact.

### Putting it All Together:

Ensure you have the following files in your GitLab repository:

1. `.gitlab-ci.yml`
2. `rhel9-packer-template.pkr.hcl`
3. `playbook.yml`
4. Any additional scripts or files referenced in your Packer template or Ansible playbooks.

With this setup, when you push changes to your GitLab repository, the CI/CD pipeline will run, build the RHEL 9 QCOW2 image using Packer, apply the Ansible playbooks, and save the resulting image as an artifact.


PACKER_LOG=1 CHECKPOINT_DISABLE=1 /usr/local/bin/packer.io/packer build --force base-image.pkr.hcl | tee lin_packer.log
